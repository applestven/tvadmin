## TV Admin 后台管理系统设计文档

### 项目概述

TV Admin 是一个基于 Nuxt 3 的后台管理系统，用于管理视频下载（TV）和语音转文字（DV）任务，支持公网与内网自动切换。该系统专为运维人员和系统管理员设计，提供统一的界面来管理 TV 下载服务和 DV 转译服务的任务状态、日志监控和系统健康检查。

### 技术架构

#### 技术栈
- **框架**: Nuxt 3 (3.14.0+)
- **UI 组件库**: Ant Design Vue 4.x
- **样式**: TailwindCSS + 自定义 CSS
- **图表**: ECharts 5.5.1 + vue-echarts 7.0.3
- **语言**: TypeScript 5.7.2+
- **构建工具**: Vite（Nuxt 内置）
- **包管理**: pnpm

#### 架构图
```
浏览器 (Nuxt SSR) → Nuxt Server → TV/DV 服务
                                    ↑
                               代理转发 (Proxy)
```

所有 API 请求均由 Nuxt Server 统一转发，避免了 CORS 问题，并实现了公网/内网的自动切换。

### 网络配置

系统支持公网/内网双 API 切换，优先使用公网，公网不可用时自动切换至内网：

- **公网 TV 服务**: http://43.139.236.50:8686/tv
- **公网 DV 服务**: http://43.139.236.50:8686/dv
- **内网 TV 服务**: http://192.168.191.168:6789
- **内网 DV 服务**: http://192.168.191.168:3456

### 代理配置

| 前端请求      | 代理目标    |
| ------------- | ----------- |
| `/api/tv/*`   | TV 下载服务 |
| `/api/dv/*`   | DV 转译服务 |
| `/api/health` | 健康检查    |

### 项目结构

```
admin-panel/
├── assets/
│   └── styles/
│       └── main.css          # 主样式文件
├── components/
│   ├── charts/
│   │   ├── StatsCards.vue    # 统计卡片组件
│   │   └── TrafficChart.vue  # 图表组件
│   └── layout/
│       └── LogContainer.vue  # 日志容器组件
├── composables/
│   ├── useApi.ts             # 通用 API 封装
│   ├── useDvApi.ts           # DV API 封装
│   ├── useNetworkStatus.ts   # 网络状态监控
│   └── useTvApi.ts           # TV API 封装
├── layouts/
│   └── default.vue           # 默认布局
├── pages/
│   ├── download/
│   │   ├── [id].vue          # 下载详情页
│   │   └── index.vue         # 下载管理列表
│   ├── transcode/
│   │   ├── [id].vue          # 转译详情页
│   │   └── index.vue         # 转译管理列表
│   ├── logs/
│   │   └── index.vue         # 日志监控页
│   └── index.vue             # 仪表盘
├── plugins/
│   └── antdv.ts              # Ant Design Vue 插件
├── server/
│   ├── api/
│   │   ├── dv/
│   │   │   └── [...].ts      # DV API 代理
│   │   ├── tv/
│   │   │   └── [...].ts      # TV API 代理
│   │   └── health.ts         # 健康检查
│   └── utils/
│       ├── config.ts         # 服务器配置
│       ├── network-checker.ts # 网络状态检测
│       └── proxy.ts          # 代理逻辑
├── types/
│   ├── api.d.ts              # 通用 API 类型定义
│   ├── dv.d.ts               # DV API 类型定义
│   └── tv.d.ts               # TV API 类型定义
├── utils/
│   ├── api-client.ts         # API 客户端
│   └── error-handler.ts      # 错误处理
├── app.vue                   # 应用根组件
├── nuxt.config.ts            # Nuxt 配置
├── package.json              # 项目配置
├── pnpm-lock.yaml            # 依赖锁定文件
├── tailwind.config.js        # Tailwind 配置
└── tsconfig.json             # TypeScript 配置
```

### 页面设计

#### 首页 (仪表盘)
仪表盘页面提供实时的数据概览，包括：

1. **统计数据卡片**:
   - 下载任务总数（成功/失败）
   - 转译任务总数（成功/失败）
   - 正在下载（运行中/等待中）
   - 正在转译（运行中/队列中）

2. **图表展示**:
   - 下载任务统计饼图
   - 转译任务统计饼图

3. **实时任务监控**:
   - 正在下载的任务列表
   - 转译队列任务列表
   - 数据每30秒自动刷新

#### 下载管理页面
提供对视频下载任务的全面管理，支持：

- 任务筛选查询（ID、URL、状态、质量等）
- 任务列表展示
- 任务详情查看
- 任务状态监控

##### TV 任务类型定义
```typescript
// 任务状态
export type TvTaskStatus = 'pending' | 'running' | 'success' | 'failed'

// 视频质量
export type VideoQuality = 'video_best' | 'audio_best' | 'video_worst' | 'audio_worst'

// 任务对象
export interface TvTask {
  id: string
  url: string
  quality: VideoQuality
  status: TvTaskStatus
  location?: string
  createdAt: number
  startedAt?: number
  finishedAt?: number
  strategy?: string
  output?: string
  outputName?: string
  error?: string
}
```

#### 转译管理页面
提供对语音转文字任务的管理，支持：

- 任务筛选查询（状态、质量、位置等）
- 任务列表展示
- 任务详情查看
- 转译队列监控

##### DV 任务类型定义
```typescript
// 任务状态
export type DvTaskStatus = 'pending' | 'queued' | 'running' | 'success' | 'failed'

// 模型质量
export type ModelQuality = 'tiny' | 'base' | 'small' | 'medium' | 'large'

// 转译任务对象
export interface DvTask {
  id: string
  url: string
  quality: ModelQuality
  status: DvTaskStatus
  location?: string
  languageArray?: string
  createdAt?: number
  startedAt?: number
  finishedAt?: number
  progress?: number
  output?: string
  error?: string
}
```

#### 日志监控页面
提供日志监控功能，包括：

- 日志容器布局（根据容器数量动态调整网格布局）
- 服务器列表管理
- 实时日志预览
- 固定底部操作面板

##### 日志容器布局规则
- 1个容器：占满全屏宽度
- 2个容器：各占一半宽度
- 3个容器：各占四分之一宽度（最多3个）
- 5个容器：各占六分之一宽度
- 7个容器：各占九分之一宽度
- 12个及以上：各占十二分之一宽度

### API 类型定义

#### 通用响应类型
```typescript
export interface ApiResponse<T = any> {
  code?: number
  data?: T
  message?: string
}

export interface PaginatedResponse<T> {
  code: number
  data: T[]
  total: number
  page: number
  pageSize: number
  message?: string
}
```

#### 统计数据类型
```typescript
// TV 统计
export interface TvStats {
  totalTasks: number
  successTasks: number
  failedTasks: number
  runningTasks: number
  pendingTasks: number
  totalDownloadSize?: number
}

// DV 统计
export interface DvStats {
  totalTasks: number
  successTasks: number
  failedTasks: number
  runningTasks: number
  queuedTasks: number
  pendingTasks: number
}
```

### 组合式函数 (Composables)

#### useNetworkStatus.ts
- 提供网络状态检测功能
- 自动切换公网/内网模式
- 定时轮询网络状态

#### useTvApi.ts
- 封装 TV 服务的所有 API 调用
- 提供任务管理、统计、运行状态等功能

#### useDvApi.ts
- 封装 DV 服务的所有 API 调用
- 提供转译任务管理、队列状态等功能

### 运行命令

```bash
# 安装依赖
pnpm install

# 开发模式（端口 3080）
pnpm dev

# 构建生产版本
pnpm build

# 预览生产版本
pnpm preview

# 生成静态文件
pnpm generate

# 代码检查
pnpm lint

# 修复代码问题
pnpm lint:fix
```

### 部署配置

- 构建为 SSR 应用或静态站点
- 需要配置运行时环境变量
- 需要支持代理规则（/api/* → TV/DV 服务）

### 安全考虑

- 所有 API 请求通过服务端代理，避免暴露真实服务地址
- 使用反向代理隔离前后端通信
- 支持 CORS 配置以确保跨域安全

### 性能优化

- 使用 Nuxt 的 SSR 功能提升首屏加载速度
- 实现数据缓存和定时刷新机制
- 优化组件懒加载和按需加载